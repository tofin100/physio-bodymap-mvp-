<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PhysioNote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --border:#d1d5db;
      --border-strong:#9ca3af;
      --accent:#06b6d4;
      --accent-soft:rgba(6,182,212,.10);
      --accent-dark:#0f172a;
      --text:#111827;
      --muted:#6b7280;
      --danger:#b91c1c;
      --ok:#16a34a;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app-shell{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    .card{
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 18px 20px;
    }
    .card + .card{ margin-top: 16px; }

    /* Header */
    .hero-card{
      position: relative;
      overflow: hidden;
    }
    .hero-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at top, rgba(15,118,190,0.12), transparent 55%),
        radial-gradient(circle at 20% 30%, rgba(6,182,212,0.10), transparent 55%);
      pointer-events:none;
    }

    .hero-inner{
      position: relative;
      z-index: 1;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .brand{
      min-width: 260px;
      flex: 1;
    }

    .hero-title{
      margin:0;
      font-size: 30px;
      font-weight: 900;
      letter-spacing: -0.04em;
      color: var(--accent-dark);
      line-height: 1.05;
    }
    .hero-title span{
      background: linear-gradient(to right, #0f172a, #0284c7);
      -webkit-background-clip: text;
      color: transparent;
    }
    .hero-sub{
      margin: 8px 0 0;
      font-size: 14px;
      color: var(--muted);
      max-width: 720px;
      line-height: 1.45;
    }

    .hud{
      display:flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      min-width: 320px;
    }
    @media(max-width: 920px){
      .hud{ align-items:flex-start; min-width:auto; }
    }

    .mic-indicator{
      font-size: 12px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.80);
      color: var(--muted);
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      white-space: nowrap;
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(107,114,128,.35);
    }
    .mic-indicator.active{ border-color: rgba(34,197,94,.35); }
    .mic-indicator.active .dot{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.12); }
    .mic-indicator.error{ border-color: rgba(239,68,68,.35); }
    .mic-indicator.error .dot{ background: var(--danger); box-shadow: 0 0 0 4px rgba(239,68,68,.12); }

    .hudline{
      font-size: 11px;
      color: var(--muted);
      padding: 7px 10px;
      border: 1px solid rgba(15,23,42,0.10);
      background: rgba(255,255,255,0.72);
      border-radius: 999px;
      max-width: 520px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Controls row */
    .row{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .row-left{ display:flex; flex-wrap:wrap; align-items:center; gap: 8px; }

    .section-title{
      font-size: 14px;
      font-weight: 800;
      margin: 0 0 8px;
      color: var(--accent-dark);
    }
    .meta{ font-size: 12px; color: var(--muted); line-height: 1.4; }

    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 4px;
    }

    input[type="text"], input[type="date"], input[type="number"], select, textarea{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text);
      font-size: 13px;
      padding: 9px 10px;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(6,182,212,0.18);
      background: #ffffff;
    }
    textarea{
      resize: vertical;
      line-height: 1.5;
      min-height: 220px;
      max-height: 420px;
    }

    .button{
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 7px;
      transition: all 0.15s ease-out;
      user-select:none;
      white-space: nowrap;
    }
    .button-primary{
      background: var(--accent);
      color: #ecfeff;
      box-shadow: 0 10px 26px rgba(6,182,212,0.25);
    }
    .button-primary:hover{ filter: brightness(1.03); transform: translateY(-1px); }
    .button-ghost{
      background: #f9fafb;
      color: var(--accent-dark);
      border: 1px solid var(--border);
    }
    .button-ghost:hover{ background:#ffffff; }
    .button-danger{
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    /* Grids */
    .grid-two{
      display:grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 12px;
    }
    @media(max-width: 900px){
      .grid-two{ grid-template-columns: 1fr; }
    }

    /* Tabs */
    .tabs-wrapper{ margin-top: 10px; }
    .tab-buttons{
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .tab-label{
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--muted);
      user-select:none;
      font-weight: 800;
    }
    .tab-label.active{
      background: var(--accent);
      color: #ecfeff;
      border-color: var(--accent);
      box-shadow: 0 6px 18px rgba(6,182,212,0.30);
    }
    .tab-label.filled{
      border-color: rgba(34,197,94,0.60);
      color: #166534;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.25);
    }

    .tab-panels{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 12px 14px;
    }
    .tab-panel{ display:none; }
    .tab-panel.active{ display:block; }

    /* Focus ring for voice-selected elements */
    .focus-ring{
      outline: 2px solid rgba(6,182,212,0.95) !important;
      box-shadow: 0 0 0 4px rgba(6,182,212,0.14) !important;
      background: #fff !important;
    }

    /* Status box */
    .status{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(15,23,42,0.18);
      background: rgba(255,255,255,0.70);
      padding: 10px 12px;
      font-size: 12px;
      color: #475569;
      line-height: 1.45;
      word-break: break-word;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .kbd{
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid rgba(15,23,42,0.14);
      border-radius: 6px;
      background: rgba(255,255,255,0.75);
    }
  </style>
</head>

<body>
  <div class="app-shell">

    <!-- Header -->
    <div class="card hero-card">
      <div class="hero-inner">
        <div class="brand">
          <h1 class="hero-title"><span>PhysioNote</span></h1>
          <p class="hero-sub">
            Voice-first Dokumentation: <b>‚Äû√ñffne Anamnese‚Äú</b> ‚Üí sprechen ‚Üí <b>‚ÄûSchlie√üen‚Äú</b>.
            Alle Bereiche, Felder und Aktionen sind per Sprache steuerbar.
          </p>
          <div class="meta" style="margin-top:10px;">
            Beispiele: <span class="mono">‚ÄûName Max Mustermann‚Äú</span> ¬∑ <span class="mono">‚ÄûGeburtsdatum 20.12.1996‚Äú</span> ¬∑
            <span class="mono">‚Äû√ñffne Befund‚Äú</span> ¬∑ <span class="mono">‚ÄûSpeichern‚Äú</span> ¬∑ <span class="mono">‚ÄûKopieren‚Äú</span>
          </div>
        </div>

        <div class="hud">
          <div id="micBox" class="mic-indicator">
            <span class="dot" id="micDot"></span>
            <span id="micLabel">Mikrofon bereit</span>
          </div>
          <div class="hudline" id="hudHeard">Geh√∂rt: ‚Äì</div>
          <div class="hudline" id="hudAction">Aktion: ‚Äì</div>
        </div>
      </div>
    </div>

    <!-- Patient -->
    <div class="card">
      <div class="row">
        <div>
          <h3 class="section-title">Patient</h3>
          <div class="meta">Tipp: Du kannst auch erst <span class="mono">‚ÄûFeld Name‚Äú</span> sagen und dann den Wert.</div>
        </div>
        <div class="row-left">
          <button class="button button-primary" id="btnStart" type="button">üéôÔ∏è Start Listening</button>
          <button class="button button-ghost" id="btnStop" type="button">Stop</button>
          <button class="button button-danger" id="btnReset" type="button">Reset</button>
        </div>
      </div>

      <div class="grid-two">
        <div>
          <label for="patient-name">Name *</label>
          <input id="patient-name" type="text" placeholder="Max Mustermann" autocomplete="off" />
        </div>
        <div>
          <label for="patient-birthdate">Geburtsdatum</label>
          <input id="patient-birthdate" type="text" placeholder="20.12.1996" autocomplete="off" />
        </div>
        <div>
          <label for="patient-phone">Telefon</label>
          <input id="patient-phone" type="text" placeholder="+41 79 123 45 67" autocomplete="off" />
        </div>
        <div>
          <label for="patient-email">E-Mail</label>
          <input id="patient-email" type="text" placeholder="max@example.com" autocomplete="off" />
        </div>
      </div>

      <div class="row" style="margin-top: 12px;">
        <div class="meta" id="activeFieldLabel">Aktives Feld: ‚Äì</div>
        <div class="row-left">
          <button class="button button-primary" id="btnSaveTop" type="button">üíæ Speichern</button>
          <button class="button button-ghost" id="btnCopyTop" type="button">üìã Kopieren</button>
          <button class="button button-ghost" id="btnClearField" type="button">üßπ Feld l√∂schen</button>
        </div>
      </div>

      <div class="status" id="statusBox">
        Status: bereit. <span class="mono">Space</span> = Mic an/aus ¬∑ <span class="mono">Esc</span> = Aufnahme stoppen & Fokus aus
      </div>
    </div>

    <!-- Sitzung -->
    <div class="card">
      <div class="row">
        <div>
          <h3 class="section-title">Sitzung</h3>
          <div class="meta">Voice-Workflow: <span class="mono">‚Äû√ñffne Anamnese‚Äú</span> ‚Üí sprechen ‚Üí <span class="mono">‚ÄûSchlie√üen‚Äú</span> ‚Üí n√§chster Tab.</div>
        </div>
        <div class="row-left">
          <button class="button button-primary" id="btnSave" type="button">üíæ Speichern</button>
          <button class="button button-ghost" id="btnCopy" type="button">üìã Kopieren</button>
        </div>
      </div>

      <div class="tabs-wrapper">
        <div class="tab-buttons" id="tab-buttons">
          <button type="button" class="tab-label active" data-tab="anamnese">Anamnese</button>
          <button type="button" class="tab-label" data-tab="befund">Befund</button>
          <button type="button" class="tab-label" data-tab="diagnose">Diagnose</button>
          <button type="button" class="tab-label" data-tab="therapieplan">Therapieplan</button>
          <button type="button" class="tab-label" data-tab="verlauf">Verlauf</button>
          <button type="button" class="tab-label" data-tab="epikrise">Epikrise</button>
          <button type="button" class="tab-label" data-tab="notes">Zusatznotizen</button>
        </div>

        <div class="tab-panels" id="tab-panels">
          <div class="tab-panel active" data-panel="anamnese">
            <label for="t-anamnese">Anamnese</label>
            <textarea id="t-anamnese" placeholder="‚Äû√ñffne Anamnese‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="befund">
            <label for="t-befund">Befund</label>
            <textarea id="t-befund" placeholder="‚Äû√ñffne Befund‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="diagnose">
            <label for="t-diagnose">Diagnose</label>
            <textarea id="t-diagnose" placeholder="‚Äû√ñffne Diagnose‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="therapieplan">
            <label for="t-therapieplan">Therapieplan</label>
            <textarea id="t-therapieplan" placeholder="‚Äû√ñffne Therapieplan‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="verlauf">
            <label for="t-verlauf">Verlauf</label>
            <textarea id="t-verlauf" placeholder="‚Äû√ñffne Verlauf‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="epikrise">
            <label for="t-epikrise">Epikrise</label>
            <textarea id="t-epikrise" placeholder="‚Äû√ñffne Epikrise‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>

          <div class="tab-panel" data-panel="notes">
            <label for="t-notes">Zusatznotizen</label>
            <textarea id="t-notes" placeholder="‚Äû√ñffne Zusatznotizen‚Äú ‚Üí diktieren ‚Ä¶"></textarea>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================================================
   PhysioNote ‚Äì Voice-First Index (Standalone)
   - Web Speech API
   - "√ñffne <Tab>" ‚Üí Tab aktivieren + Aufnahme an (append in Textarea)
   - "Schlie√üen" ‚Üí Aufnahme aus
   - "Name Max Mustermann" / "Geburtsdatum 20.12.1996" / "Telefon ..." / "E-Mail ..."
   - "Feld Name" ‚Üí Fokus setzen
   - "Feld l√∂schen" ‚Üí aktives Feld leeren
   - "Speichern" / "Kopieren"
   ========================================================= */

(() => {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

  // UI
  const micBox   = document.getElementById("micBox");
  const micLabel = document.getElementById("micLabel");
  const hudHeard = document.getElementById("hudHeard");
  const hudAction= document.getElementById("hudAction");
  const statusBox= document.getElementById("statusBox");
  const activeFieldLabel = document.getElementById("activeFieldLabel");

  // Buttons
  const btnStart = document.getElementById("btnStart");
  const btnStop  = document.getElementById("btnStop");
  const btnReset = document.getElementById("btnReset");
  const btnClearField = document.getElementById("btnClearField");
  const btnSave  = document.getElementById("btnSave");
  const btnCopy  = document.getElementById("btnCopy");
  const btnSaveTop = document.getElementById("btnSaveTop");
  const btnCopyTop = document.getElementById("btnCopyTop");

  // Inputs
  const patient = {
    name: document.getElementById("patient-name"),
    birthdate: document.getElementById("patient-birthdate"),
    phone: document.getElementById("patient-phone"),
    email: document.getElementById("patient-email"),
  };

  // Tabs / panels
  const tabButtons = [...document.querySelectorAll(".tab-label")];
  const tabPanels  = [...document.querySelectorAll(".tab-panel")];

  const textareas = {
    anamnese: document.getElementById("t-anamnese"),
    befund: document.getElementById("t-befund"),
    diagnose: document.getElementById("t-diagnose"),
    therapieplan: document.getElementById("t-therapieplan"),
    verlauf: document.getElementById("t-verlauf"),
    epikrise: document.getElementById("t-epikrise"),
    notes: document.getElementById("t-notes"),
  };

  const TAB_KEYS = Object.keys(textareas);

  const tabAliases = {
    anamnese: ["anamnese","anamnesebogen","anamnese bogen","anamnese vom bogen","anamnese von bogen","anamnese formular"],
    befund: ["befund","status","befundbogen","befund bogen"],
    diagnose: ["diagnose","einschaetzung","einsch√§tzung","assessment"],
    therapieplan: ["therapieplan","therapie plan","plan","therapie"],
    verlauf: ["verlauf","follow up","followup"],
    epikrise: ["epikrise","abschluss","abschlussbericht"],
    notes: ["notizen","zusatznotizen","zusatz notizen","zusatz","hinweise"]
  };

  // State
  let recognition = null;
  let listening = false;
  let recording = false;       // append speech into active textarea
  let activeTab = "anamnese";
  let focusEl = null;
  let focusLabel = "";

  // Helpers
  function setStatus(text){ statusBox.textContent = "Status: " + text; }
  function setHUD(heard, action){
    hudHeard.textContent  = "Geh√∂rt: " + (heard || "‚Äì");
    hudAction.textContent = "Aktion: " + (action || "‚Äì");
  }
  function normalize(s){
    return (s||"")
      .toLowerCase()
      .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/√ü/g,"ss")
      .replace(/[^\p{L}\p{N}\s:.\-+@/]/gu, " ")
      .replace(/\s+/g," ")
      .trim();
  }

  const MONTHS = {
    januar:1, jan:1, februar:2, feb:2, maerz:3, m√§rz:3, april:4, apr:4, mai:5,
    juni:6, jun:6, juli:7, jul:7, august:8, aug:8, september:9, sep:9,
    oktober:10, okt:10, november:11, nov:11, dezember:12, dez:12
  };
  const pad2 = (n) => String(n).padStart(2,"0");

  function tryNormalizeDate(val){
    const v = (val||"").trim();
    let m = v.match(/^(\d{1,2})[.\-/](\d{1,2})[.\-/](\d{2,4})$/);
    if(m){
      let d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
      if(y < 100) y = 1900 + y;
      if(d>=1 && d<=31 && mo>=1 && mo<=12 && y>=1900 && y<=2100) return `${pad2(d)}.${pad2(mo)}.${y}`;
    }
    m = normalize(v).match(/^(\d{1,2})\s*\.?\s*([a-zaeoeu]+)\s+(\d{4})$/i);
    if(m){
      const d = parseInt(m[1],10), mon = (m[2]||"").toLowerCase(), y = parseInt(m[3],10);
      const mo = MONTHS[mon];
      if(mo && d>=1 && d<=31 && y>=1900 && y<=2100) return `${pad2(d)}.${pad2(mo)}.${y}`;
    }
    return null;
  }

  function clearFocusRing(){
    document.querySelectorAll(".focus-ring").forEach(el => el.classList.remove("focus-ring"));
  }
  function setFocus(el, label){
    clearFocusRing();
    focusEl = el;
    focusLabel = label || "";
    if(el){
      el.classList.add("focus-ring");
      try{ el.focus({preventScroll:false}); }catch(e){}
    }
    activeFieldLabel.textContent = "Aktives Feld: " + (focusLabel || "‚Äì");
  }

  function updateMicUI(){
    micBox.classList.remove("active","error");
    if(listening){
      micBox.classList.add("active");
      micLabel.textContent = recording ? "Aufnahme l√§uft" : "Listening aktiv";
    } else {
      micLabel.textContent = "Mikrofon bereit";
    }
  }

  function setActiveTab(key){
    activeTab = key;

    tabButtons.forEach(b => b.classList.toggle("active", b.getAttribute("data-tab") === key));
    tabPanels.forEach(p => p.classList.toggle("active", p.getAttribute("data-panel") === key));

    // focus textarea of active tab
    setFocus(textareas[key], key.charAt(0).toUpperCase() + key.slice(1));
  }

  function updateFilledBadges(){
    tabButtons.forEach(btn => {
      const key = btn.getAttribute("data-tab");
      const ta = textareas[key];
      const filled = !!(ta && ta.value && ta.value.trim().length > 0);
      btn.classList.toggle("filled", filled);
    });
  }

  function resetAll(){
    Object.values(patient).forEach(i => i.value = "");
    Object.values(textareas).forEach(t => t.value = "");
    recording = false;
    setActiveTab("anamnese");
    setFocus(null,"");
    setStatus("zur√ºckgesetzt.");
    setHUD("‚Äì","Reset");
    updateFilledBadges();
    updateMicUI();
  }

  function stopRecording(){
    recording = false;
    setStatus("Aufnahme gestoppt.");
    setHUD("‚Äì","Schlie√üen");
    updateMicUI();
  }

  function startRecordingInto(tabKey){
    setActiveTab(tabKey);
    recording = true;
    setStatus(`Aufnahme: ${tabKey}`);
    setHUD("‚Äì",`√ñffne ${tabKey} (Aufnahme an)`);
    updateMicUI();
  }

  async function copyAll(){
    const payload = [
      `Name: ${patient.name.value || "-"}`,
      `Geburtsdatum: ${patient.birthdate.value || "-"}`,
      `Telefon: ${patient.phone.value || "-"}`,
      `E-Mail: ${patient.email.value || "-"}`,
      "",
      "ANAMNESE:",
      textareas.anamnese.value || "",
      "",
      "BEFUND:",
      textareas.befund.value || "",
      "",
      "DIAGNOSE:",
      textareas.diagnose.value || "",
      "",
      "THERAPIEPLAN:",
      textareas.therapieplan.value || "",
      "",
      "VERLAUF:",
      textareas.verlauf.value || "",
      "",
      "EPIKRISE:",
      textareas.epikrise.value || "",
      "",
      "ZUSATZNOTIZEN:",
      textareas.notes.value || ""
    ].join("\n");

    try{
      await navigator.clipboard.writeText(payload);
      setStatus("kopiert.");
      setHUD("‚Äì","Kopieren");
    }catch(e){
      setStatus("Kopieren nicht m√∂glich (Browser-Berechtigung).");
      setHUD("‚Äì","Kopieren fehlgeschlagen");
    }
  }

  function save(){
    // Demo: nur UX-Feedback (euer echtes Speichern h√§ngt sp√§ter an API / App-State)
    setStatus("gespeichert.");
    setHUD("‚Äì","Speichern");
  }

  function clearFocusedField(){
    if(!focusEl){
      setStatus("kein aktives Feld.");
      setHUD("‚Äì","Feld l√∂schen (kein Fokus)");
      return;
    }
    focusEl.value = "";
    focusEl.dispatchEvent(new Event("input"));
    setStatus(`gel√∂scht: ${focusLabel || "Feld"}.`);
    setHUD("‚Äì","Feld l√∂schen");
    updateFilledBadges();
  }

  // Field mapping (voice)
  const FIELD_SYNONYMS = [
    { key:"name", label:"Name", el: patient.name, syn:["name","patient","patientenname","patient name"] },
    { key:"birthdate", label:"Geburtsdatum", el: patient.birthdate, syn:["geburtsdatum","geburtstag","geb datum","geburt"] },
    { key:"phone", label:"Telefon", el: patient.phone, syn:["telefon","handy","nummer","telefonnummer","tel"] },
    { key:"email", label:"E-Mail", el: patient.email, syn:["email","e mail","e-mail","mail"] }
  ];

  function matchFieldKey(head){
    const h = normalize(head);
    for(const f of FIELD_SYNONYMS){
      for(const s of f.syn){
        if(h === normalize(s)) return f;
      }
    }
    return null;
  }

  function setFieldValue(fieldObj, value){
    if(!fieldObj) return false;
    let v = (value||"").trim();

    if(fieldObj.key === "birthdate"){
      const nd = tryNormalizeDate(v);
      if(nd) v = nd;
    }
    if(fieldObj.key === "email"){
      v = v.replace(/\s+/g,"").trim();
    }
    if(fieldObj.key === "phone"){
      v = v.replace(/[^\d+\s]/g,"").replace(/\s+/g," ").trim();
    }

    setFocus(fieldObj.el, fieldObj.label);
    fieldObj.el.value = v;
    fieldObj.el.dispatchEvent(new Event("input"));
    setStatus(`${fieldObj.label} gesetzt.`);
    setHUD(value, `Setze ${fieldObj.label}`);
    return true;
  }

  // Tab clicks
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-tab");
      setActiveTab(key);
      // Klick soll NICHT automatisch Aufnahme starten (nur Voice/Workflow)
      setStatus(`Tab: ${key}`);
      setHUD("‚Äì", `Tab wechseln`);
      updateFilledBadges();
    });
  });

  // filled badges
  Object.values(textareas).forEach(t => t.addEventListener("input", updateFilledBadges));
  updateFilledBadges();

  // Speech engine
  function buildRecognition(){
    if(!SR){
      micBox.classList.add("error");
      micLabel.textContent = "Speech API fehlt";
      setStatus("SpeechRecognition nicht verf√ºgbar. Nutze Chrome (Desktop/Android) oder Safari mit Support.");
      setHUD("‚Äì","Nicht unterst√ºtzt");
      return null;
    }
    const r = new SR();
    r.lang = "de-DE";
    r.continuous = true;
    r.interimResults = false;
    return r;
  }

  function startListening(){
    if(listening) return;
    recognition = buildRecognition();
    if(!recognition) return;

    recognition.onstart = () => {
      listening = true;
      setStatus("Listening aktiv.");
      setHUD("‚Äì","Listening an");
      updateMicUI();
    };

    recognition.onerror = (e) => {
      micBox.classList.add("error");
      setStatus(`Mikro-Fehler: ${e.error || "unknown"}`);
      setHUD("‚Äì","Speech error");
      updateMicUI();
    };

    recognition.onend = () => {
      // Auto-Restart solange listening true
      if(listening){
        try{ recognition.start(); }catch(e){}
      }
    };

    recognition.onresult = (ev) => {
      const raw = (ev.results[ev.results.length - 1][0].transcript || "").trim();
      if(!raw) return;

      const t = normalize(raw);
      setHUD(raw, "‚Ä¶");

      // Global listening control
      if(t.includes("stop listening") || t.includes("listening stoppen") || t.includes("mikro aus") || t.includes("mikrofon aus") || t === "stop"){
        stopListening(); return;
      }
      if(t.includes("start listening") || t.includes("listening starten") || t.includes("mikro an") || t.includes("mikrofon an")){
        // already listening
        setStatus("Listening aktiv.");
        setHUD(raw,"Listening an");
        updateMicUI();
        return;
      }

      // Reset
      if(t === "reset" || t.includes("alles loeschen") || t.includes("alles l√∂schen")){
        resetAll(); return;
      }

      // Close recording
      if(t === "schliessen" || t === "schlie√üen" || t.includes("aufnahme stoppen") || t.includes("diktat stoppen")){
        stopRecording(); return;
      }

      // Save / copy / clear field
      if(t === "speichern" || t.includes("sitzung speichern")){
        save(); return;
      }
      if(t.includes("kopieren") || t.includes("zwischenablage")){
        copyAll(); return;
      }
      if(t.includes("feld loeschen") || t.includes("feld l√∂schen") || t.includes("loesche feld") || t.includes("l√∂sche feld")){
        clearFocusedField(); return;
      }

      // Open tab: "√∂ffne <x>" OR direct "<x>"
      const openMatch = t.match(/^(oeffne|√∂ffne)\s+(.+)$/);
      const maybeTabPhrase = (openMatch ? openMatch[2] : t).trim();

      // direct tab name should switch + start recording ONLY if it matches a tab alias exactly
      let matchedTab = null;

      for(const key of TAB_KEYS){
        const al = tabAliases[key] || [key];
        const exact = al.some(a => normalize(a) === maybeTabPhrase);
        const contains = al.some(a => maybeTabPhrase.includes(normalize(a)));
        if(openMatch && contains){ matchedTab = key; break; }
        if(!openMatch && exact){ matchedTab = key; break; }
      }

      if(matchedTab){
        startRecordingInto(matchedTab);
        return;
      }

      // Focus field: "feld name" / "fokus name"
      const focusMatch = t.match(/^(feld|fokus)\s+(.+)$/);
      if(focusMatch){
        const f = matchFieldKey(focusMatch[2].trim());
        if(f){
          setFocus(f.el, f.label);
          setStatus(`Fokus: ${f.label}.`);
          setHUD(raw, "Fokus");
          updateMicUI();
          return;
        }
      }

      // Set field: "Name Max" / "Geburtsdatum: ..." / "Setze Name auf ..."
      let m = t.match(/^(setze|korrigiere)\s+(.+?)\s+(auf|zu)\s+(.+)$/);
      if(m){
        const f = matchFieldKey(m[2].trim());
        if(f){ setFieldValue(f, m[4]); return; }
      }

      m = raw.match(/^(.+?)\s*:\s*(.+)$/); // keep raw for values
      if(m){
        const f = matchFieldKey(m[1].trim());
        if(f){ setFieldValue(f, m[2]); return; }
      }

      // "Name <value>" style (longest synonym first)
      const synCandidates = FIELD_SYNONYMS
        .flatMap(f => f.syn.map(s => ({ f, syn: normalize(s) })))
        .sort((a,b) => b.syn.length - a.syn.length);

      for(const c of synCandidates){
        if(t === c.syn){
          setFocus(c.f.el, c.f.label);
          setStatus(`Fokus: ${c.f.label}.`);
          setHUD(raw, "Fokus");
          updateMicUI();
          return;
        }
        if(t.startsWith(c.syn + " ")){
          const val = raw.slice(raw.toLowerCase().indexOf(c.syn) + c.syn.length).trim();
          if(val){ setFieldValue(c.f, val); return; }
        }
      }

      // If recording: append to active textarea
      if(recording && textareas[activeTab]){
        const ta = textareas[activeTab];
        const prefix = ta.value && ta.value.trim().length ? " " : "";
        ta.value = ta.value + prefix + raw;
        ta.dispatchEvent(new Event("input"));
        setFocus(ta, activeTab.charAt(0).toUpperCase() + activeTab.slice(1));
        setStatus("Aufnahme l√§uft ‚Ä¶");
        setHUD(raw, "Diktat ‚Üí " + activeTab);
        updateFilledBadges();
        updateMicUI();
        return;
      }

      // If not recording and a patient input is focused, set it directly
      if(!recording && focusEl && focusEl.tagName === "INPUT"){
        focusEl.value = raw;
        focusEl.dispatchEvent(new Event("input"));
        setStatus("Wert gesetzt.");
        setHUD(raw, "Set focused input");
        updateMicUI();
        return;
      }

      setStatus("Nicht erkannt. Sage z. B. ‚Äû√ñffne Anamnese‚Äú, ‚ÄûSchlie√üen‚Äú, ‚ÄûName ‚Ä¶‚Äú, ‚ÄûSpeichern‚Äú.");
      setHUD(raw, "Unklar");
      updateMicUI();
    };

    try{ recognition.start(); }catch(e){}
  }

  function stopListening(){
    listening = false;
    recording = false;
    try{ recognition && recognition.stop(); }catch(e){}
    setStatus("Listening gestoppt.");
    setHUD("‚Äì","Listening aus");
    updateMicUI();
  }

  // Buttons
  btnStart.addEventListener("click", startListening);
  btnStop.addEventListener("click", stopListening);
  btnReset.addEventListener("click", resetAll);
  btnClearField.addEventListener("click", clearFocusedField);
  btnSave.addEventListener("click", save);
  btnCopy.addEventListener("click", copyAll);
  btnSaveTop.addEventListener("click", save);
  btnCopyTop.addEventListener("click", copyAll);

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if(e.code === "Space" && !e.repeat){
      e.preventDefault();
      if(!listening) startListening();
      else stopListening();
    }
    if(e.code === "Escape"){
      e.preventDefault();
      recording = false;
      clearFocusRing();
      focusEl = null;
      focusLabel = "";
      activeFieldLabel.textContent = "Aktives Feld: ‚Äì";
      setStatus("Aufnahme aus. Fokus aus.");
      setHUD("‚Äì","Esc");
      updateMicUI();
    }
  });

  // Init
  setActiveTab("anamnese");
  setStatus("bereit.");
  setHUD("‚Äì","‚Äì");
  updateMicUI();
})();
</script>

</body>
</html>