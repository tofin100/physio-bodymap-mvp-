<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Interaktive Körperkarte – Avatar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #f9fafb;
      --bg-card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --pin: #2563eb;
      --pin-border: #1d4ed8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-page);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .card {
      width: 100%;
      max-width: 1024px;
      background: var(--bg-card);
      border-radius: 1rem;
      border: 1px solid var(--border);
      box-shadow:
        0 20px 25px -5px rgba(15, 23, 42, 0.05),
        0 8px 10px -6px rgba(15, 23, 42, 0.03);
      padding: 1.25rem 1.5rem 1.25rem;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    .bodies {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .body-panel {
      position: relative;
      width: min(46%, 360px);
      min-width: 260px;
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      overflow: hidden;
      background: #ffffff;
    }

    .body-label {
      position: absolute;
      top: 0.4rem;
      left: 0.55rem;
      padding: 0.18rem 0.45rem;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.65rem;
      color: var(--muted);
      z-index: 3;
    }

    .body-img-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 200%; /* Seitenverhältnis: hochkant */
      background: #ffffff;
    }

    .body-img-wrapper img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none; /* Klicks gehen an das SVG */
    }

    .body-overlay {
      position: absolute;
      inset: 0;
      cursor: crosshair;
    }

    svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .pin {
      fill: var(--pin);
      stroke: var(--pin-border);
      stroke-width: 0.8;
      cursor: pointer;
    }

    .pin:hover {
      stroke-width: 1.4;
    }

    .legend {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--muted);
      align-items: center;
    }

    .legend-pin {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--pin);
      border: 2px solid var(--pin-border);
      margin-right: 0.25rem;
    }

    @media (max-width: 720px) {
      .card {
        padding: 1rem;
      }
      .body-panel {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Interaktive Körperkarte</div>
        <div class="card-subtitle">
          Vorder- und Rückansicht mit Muskel-/Skelettdarstellung. Pins markieren Schmerzpunkte oder Befunde.
        </div>
      </div>
    </div>

    <div class="hint">
      <strong>Bedienung:</strong> Klick auf den Körper setzt einen Pin. Klick auf einen Pin entfernt ihn wieder.
    </div>

    <div class="bodies">
      <!-- Vorderseite -->
      <div class="body-panel">
        <div class="body-label">Vorderseite</div>
        <div class="body-img-wrapper">
          <!-- TODO: Ersetze 'body-front.png' durch dein eigenes Bild -->
          <img src="body-front.png" alt="Körper Vorderseite – Muskel/Skelett" />
          <div class="body-overlay">
            <svg viewBox="0 0 100 200" data-side="front">
              <!-- Pins werden per JS hier eingefügt -->
            </svg>
          </div>
        </div>
      </div>

      <!-- Rückseite -->
      <div class="body-panel">
        <div class="body-label">Rückseite</div>
        <div class="body-img-wrapper">
          <!-- TODO: Ersetze 'body-back.png' durch dein eigenes Bild -->
          <img src="body-back.png" alt="Körper Rückseite – Muskel/Skelett" />
          <div class="body-overlay">
            <svg viewBox="0 0 100 200" data-side="back">
              <!-- Pins werden per JS hier eingefügt -->
            </svg>
          </div>
        </div>
      </div>
    </div>

    <div class="legend">
      <span><span class="legend-pin"></span>Pin = markierter Punkt</span>
      <span>• Klick auf Körper = neuen Pin setzen</span>
      <span>• Klick auf Pin = Pin löschen</span>
    </div>
  </div>

  <script>
    // -------------------------------
    // State: Pins als Prozentwerte
    // -------------------------------
    const STORAGE_KEY = "bodymap_pins_v1";

    let pins = {
      front: [], // { id, x, y }
      back: []
    };

    function loadPins() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          pins.front = Array.isArray(parsed.front) ? parsed.front : [];
          pins.back = Array.isArray(parsed.back) ? parsed.back : [];
        }
      } catch (e) {
        console.error("Fehler beim Laden der Pins:", e);
      }
    }

    function savePins() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(pins));
    }

    function createId() {
      return (
        Math.random().toString(36).slice(2, 8) +
        "-" +
        Date.now().toString(36)
      );
    }

    // -------------------------------
    // Rendering
    // -------------------------------
    function renderPinsForSide(side) {
      const svg = document.querySelector(`svg[data-side="${side}"]`);
      if (!svg) return;

      // Alte Pins entfernen
      while (svg.firstChild) {
        svg.removeChild(svg.firstChild);
      }

      const data = pins[side] || [];
      data.forEach(pin => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", pin.x);
        circle.setAttribute("cy", pin.y);
        circle.setAttribute("r", "2.8"); // Radius in ViewBox-Einheiten
        circle.setAttribute("class", "pin");
        circle.dataset.id = pin.id;
        circle.addEventListener("click", evt => {
          evt.stopPropagation(); // verhindert neuen Pin
          removePin(side, pin.id);
        });
        svg.appendChild(circle);
      });
    }

    function renderAllPins() {
      renderPinsForSide("front");
      renderPinsForSide("back");
    }

    // -------------------------------
    // Pin-Management
    // -------------------------------
    function addPin(side, x, y) {
      const pin = { id: createId(), x, y };
      pins[side].push(pin);
      savePins();
      renderPinsForSide(side);
    }

    function removePin(side, id) {
      pins[side] = pins[side].filter(p => p.id !== id);
      savePins();
      renderPinsForSide(side);
    }

    // -------------------------------
    // Klick-Logik
    // -------------------------------
    function setupClickHandlers() {
      document.querySelectorAll("svg[data-side]").forEach(svg => {
        svg.addEventListener("click", evt => {
          const side = svg.dataset.side;
          const rect = svg.getBoundingClientRect();
          const x = ((evt.clientX - rect.left) / rect.width) * 100;
          const y = ((evt.clientY - rect.top) / rect.height) * 200; // viewBox height = 200
          addPin(side, x, y);
        });
      });
    }

    // -------------------------------
    // Öffentliche API (optional)
    // -------------------------------
    window.PhysioAvatar = {
      /**
       * Gibt eine Kopie der aktuellen Pins zurück:
       * { front: [{id,x,y}], back: [...] }
       */
      getPins() {
        return {
          front: [...pins.front],
          back: [...pins.back]
        };
      },
      /**
       * Setzt Pins von außen. Erwartet Format wie getPins().
       */
      setPins(newPins) {
        pins.front = Array.isArray(newPins.front) ? newPins.front : [];
        pins.back = Array.isArray(newPins.back) ? newPins.back : [];
        savePins();
        renderAllPins();
      },
      /**
       * Löscht alle Pins.
       */
      clear() {
        pins.front = [];
        pins.back = [];
        savePins();
        renderAllPins();
      }
    };

    // -------------------------------
    // Init
    // -------------------------------
    loadPins();
    renderAllPins();
    setupClickHandlers();
  </script>
</body>
</html>